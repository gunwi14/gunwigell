<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œíŒ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header sticky">
        <a href="index.html" class="back-btn">â®</a>
        <h2 id="board-title">ê²Œì‹œíŒ</h2>
        <button class="write-btn" onclick="openWriteModal()">ê¸€ì“°ê¸°</button>
    </header>

    <main id="post-list" class="post-list">
        </main>

    <div id="write-modal" class="modal hidden">
        <div class="modal-content">
            <h3>ê¸€ì“°ê¸°</h3>
            <input type="text" id="input-title" placeholder="ì œëª©" autocomplete="off">
            <textarea id="input-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            
            <div class="form-options">
                <label class="file-upload">
                    ğŸ“· ì‚¬ì§„/ì˜ìƒ
                    <input type="file" id="input-file" accept="image/*, video/*">
                </label>
                <input type="password" id="input-password" placeholder="ë¹„ë°€ë²ˆí˜¸(ì‚­ì œìš©)" maxlength="4">
            </div>

            <div class="modal-buttons">
                <button onclick="closeWriteModal()" class="cancel-btn">ì·¨ì†Œ</button>
                <button onclick="savePost()" class="confirm-btn">ë“±ë¡</button>
            </div>
        </div>
    </div>

    <div id="view-modal" class="modal hidden">
        <div class="modal-content view-box">
            <button onclick="closeViewModal()" class="close-x">âœ•</button>
            
            <div id="view-header">
                <h2 id="view-title">ì œëª©</h2>
                <span id="view-meta">ìµëª… Â· ë‚ ì§œ</span>
            </div>

            <div id="view-body">
                <div id="view-media-area"></div> <p id="view-text">ë‚´ìš©</p>
            </div>

            <div class="action-buttons">
                <button onclick="vote('like')" class="vote-btn">ğŸ‘ <span id="cnt-like">0</span></button>
                <button onclick="vote('dislike')" class="vote-btn">ğŸ‘ <span id="cnt-dislike">0</span></button>
            </div>

            <hr>

            <div id="comment-list">
                </div>

            <div class="comment-input-box">
                <input type="text" id="comment-text" placeholder="ëŒ“ê¸€ ì…ë ¥...">
                <button onclick="addComment()">ë“±ë¡</button>
            </div>

            <button onclick="deletePost()" class="delete-post-btn">ì´ ê¸€ ì‚­ì œ</button>
        </div>
    </div>

    <script>
        // URLì—ì„œ ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
        const params = new URLSearchParams(window.location.search);
        const category = params.get('category') || 'free';
        const categoryNames = { free: 'ììœ ', school: 'í•™êµ', game: 'ê²Œì„', hobby: 'ì·¨ë¯¸' };
        document.getElementById('board-title').innerText = categoryNames[category] || 'ê²Œì‹œíŒ';

        let currentPostId = null;

        // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getData() {
            return JSON.parse(localStorage.getItem('gunwi_' + category)) || [];
        }
        function saveData(data) {
            localStorage.setItem('gunwi_' + category, JSON.stringify(data));
        }

        // 1. ê²Œì‹œê¸€ ëª©ë¡ ë Œë”ë§
        function renderList() {
            const list = document.getElementById('post-list');
            const data = getData();
            list.innerHTML = '';

            // ìµœì‹ ìˆœ ì •ë ¬
            data.sort((a, b) => b.id - a.id).forEach(post => {
                const item = document.createElement('div');
                item.className = 'post-item';
                item.onclick = () => openViewModal(post.id);
                
                // ì‚¬ì§„ ìˆëŠ”ì§€ í™•ì¸
                const hasMedia = post.media ? '<span class="media-badge">ğŸ“·</span>' : '';

                item.innerHTML = `
                    <div class="post-info">
                        <span class="post-item-title">${post.title} ${hasMedia}</span>
                        <span class="post-item-meta">ìµëª…${post.anonId} Â· ğŸ‘ ${post.likes}</span>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // 2. ê¸€ì“°ê¸° ê´€ë ¨
        function openWriteModal() { document.getElementById('write-modal').classList.remove('hidden'); }
        function closeWriteModal() { document.getElementById('write-modal').classList.add('hidden'); }

        function savePost() {
            const title = document.getElementById('input-title').value;
            const content = document.getElementById('input-content').value;
            const pw = document.getElementById('input-password').value;
            const fileInput = document.getElementById('input-file');

            if (!title || !content || !pw) {
                alert("ì œëª©, ë‚´ìš©, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            const processPost = (mediaData) => {
                const data = getData();
                const newId = Date.now(); // ê³ ìœ  IDë¡œ ì‹œê°„ ì‚¬ìš©
                const post = {
                    id: newId,
                    anonId: Math.floor(Math.random() * 1000) + 1, // ëœë¤ ìµëª… ë²ˆí˜¸
                    title,
                    content,
                    password: pw,
                    media: mediaData, // ì´ë¯¸ì§€ ë°ì´í„° (Base64)
                    likes: 0,
                    dislikes: 0,
                    date: new Date().toLocaleDateString(),
                    comments: []
                };
                data.push(post);
                saveData(data);
                closeWriteModal();
                renderList();
                // ì…ë ¥ì°½ ì´ˆê¸°í™”
                document.getElementById('input-title').value = '';
                document.getElementById('input-content').value = '';
                document.getElementById('input-password').value = '';
                fileInput.value = '';
            };

            // ì´ë¯¸ì§€ ì²˜ë¦¬ (Base64 ë³€í™˜)
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processPost(e.target.result);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                processPost(null);
            }
        }

        // 3. ìƒì„¸ ë³´ê¸° ê´€ë ¨
        function openViewModal(id) {
            currentPostId = id;
            const data = getData();
            const post = data.find(p => p.id === id);
            
            document.getElementById('view-title').innerText = post.title;
            document.getElementById('view-meta').innerText = `ìµëª…${post.anonId} Â· ${post.date}`;
            document.getElementById('view-text').innerText = post.content;
            document.getElementById('cnt-like').innerText = post.likes;
            document.getElementById('cnt-dislike').innerText = post.dislikes;

            const mediaArea = document.getElementById('view-media-area');
            mediaArea.innerHTML = '';
            if (post.media) {
                if (post.media.startsWith('data:video')) {
                    mediaArea.innerHTML = `<video src="${post.media}" controls style="max-width:100%"></video>`;
                } else {
                    mediaArea.innerHTML = `<img src="${post.media}" style="max-width:100%">`;
                }
            }

            renderComments(post.comments);
            document.getElementById('view-modal').classList.remove('hidden');
        }

        function closeViewModal() { document.getElementById('view-modal').classList.add('hidden'); }

        // 4. ì¢‹ì•„ìš”/ì‹«ì–´ìš” ê¸°ëŠ¥
        function vote(type) {
            const data = getData();
            const postIndex = data.findIndex(p => p.id === currentPostId);
            if (postIndex === -1) return;

            if (type === 'like') data[postIndex].likes++;
            else data[postIndex].dislikes++;

            saveData(data);
            // í™”ë©´ ê°±ì‹ 
            document.getElementById('cnt-like').innerText = data[postIndex].likes;
            document.getElementById('cnt-dislike').innerText = data[postIndex].dislikes;
            renderList(); // ëª©ë¡ì˜ ìˆ«ìë„ ê°±ì‹ 
        }

        // 5. ì‚­ì œ ê¸°ëŠ¥ (ë¹„ë°€ë²ˆí˜¸ í™•ì¸)
        function deletePost() {
            const pw = prompt("ê¸€ ì‘ì„± ì‹œ ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (!pw) return;

            const data = getData();
            const postIndex = data.findIndex(p => p.id === currentPostId);
            
            if (data[postIndex].password === pw) {
                data.splice(postIndex, 1);
                saveData(data);
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeViewModal();
                renderList();
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            }
        }

        // 6. ëŒ“ê¸€ ê¸°ëŠ¥
        function renderComments(comments) {
            const list = document.getElementById('comment-list');
            list.innerHTML = '';
            comments.forEach(c => {
                const div = document.createElement('div');
                div.className = 'comment-item';
                div.innerHTML = `<b>ìµëª…</b> ${c}`;
                list.appendChild(div);
            });
        }

        function addComment() {
            const text = document.getElementById('comment-text').value;
            if (!text) return;

            const data = getData();
            const postIndex = data.findIndex(p => p.id === currentPostId);
            data[postIndex].comments.push(text);
            saveData(data);
            
            document.getElementById('comment-text').value = '';
            renderComments(data[postIndex].comments);
        }

        // ì´ˆê¸° ì‹¤í–‰
        renderList();
    </script>
</body>
</html>
