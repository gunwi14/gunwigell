<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ê²Œì‹œíŒ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <a href="index.html" class="back-btn">â®</a>
        <h2 id="board-title">ê²Œì‹œíŒ</h2>
        <div style="width: 24px;"></div>
    </header>

    <main id="post-list" class="post-list">
        <div style="text-align:center; margin-top:50px; color:#999;">ë¡œë”©ì¤‘...</div>
    </main>

    <button class="fab-write" onclick="openWriteModal()">âœï¸</button>

    <div id="write-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-btn" onclick="closeModal('write-modal')">âœ•</button>
                <span class="modal-title" id="write-header-title">ìƒˆ ê¸€ ì‘ì„±</span>
                <button class="action-btn" id="btn-save">ë“±ë¡</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="w-title" class="input-field" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <textarea id="w-content" class="input-field" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.&#13;&#10;(ìš•ì„¤ ë° ìƒëŒ€ë°©ì„ ë¹„í•˜í•˜ëŠ” ì–¸ì–´ ì‚¬ìš© ì ˆëŒ€ ê¸ˆì§€)"></textarea>
                </div>
                
                <label class="file-upload-box">
                    <span id="file-msg">ğŸ“· ì‚¬ì§„ ë˜ëŠ” ë™ì˜ìƒ ì¶”ê°€ (í´ë¦­)</span>
                    <input type="file" id="w-file" accept="image/*, video/*" style="display:none;">
                </label>

                <div class="form-group">
                    <input type="password" id="w-pw" class="input-field" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ (ìˆ˜ì •/ì‚­ì œìš©)" maxlength="4" style="text-align:center; letter-spacing: 3px;">
                </div>
            </div>
        </div>
    </div>

    <div id="view-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-btn" onclick="closeModal('view-modal')">âœ•</button>
                <div class="btn-group">
                    <button class="small-btn" id="btn-edit">ìˆ˜ì •</button>
                    <button class="small-btn" id="btn-delete" style="color:red;">ì‚­ì œ</button>
                </div>
            </div>

            <div class="modal-body" style="padding:0;">
                <div style="padding:20px;">
                    <div class="view-title" id="v-title">ì œëª©</div>
                    <div class="view-meta" id="v-meta">ì‘ì„±ì Â· ë‚ ì§œ</div>
                    <div id="v-media" class="media-box"></div>
                    <div class="view-content" id="v-content">ë‚´ìš©</div>

                    <div class="vote-container">
                        <div class="vote-pill" onclick="handleVote('like')">
                            ğŸ‘ <span id="cnt-like">0</span>
                        </div>
                        <div class="vote-pill" onclick="handleVote('dislike')">
                            ğŸ‘ <span id="cnt-dislike">0</span>
                        </div>
                    </div>
                </div>

                <div class="comment-section">
                    <div id="comment-list"></div>
                    <div class="comment-input-wrap">
                        <input type="text" id="c-input" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”...">
                        <button onclick="addComment()">ë“±ë¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // â–¼â–¼â–¼ Firebase ì„¤ì • (index.htmlê³¼ ë˜‘ê°™ì€ í‚¤ë¥¼ ë„£ìœ¼ì„¸ìš”!) â–¼â–¼â–¼
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy, arrayUnion, increment } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYhs32HhSXtCfTHjYDWs9-i_lCj7d8UTc",
            authDomain: "gunwi-board.firebaseapp.com",
            projectId: "gunwi-board",
            storageBucket: "gunwi-board.firebasestorage.app",
            messagingSenderId: "343912898114",
            appId: "1:343912898114:web:611e8204b8a38cdd1c57db"
        };
        // â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ìˆ˜ì •í•˜ì„¸ìš” â–²â–²â–²

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ê¸°ë³¸ ì„¤ì •
        const params = new URLSearchParams(window.location.search);
        const category = params.get('category') || 'free';
        const colName = `gunwi_${category}`;
        const catTitles = { free:'ììœ ', school:'í•™êµ', game:'ê²Œì„', love:'ì—°ì• ', food:'ê¸‰ì‹', qna:'ì§ˆë¬¸' };
        document.getElementById('board-title').innerText = (catTitles[category] || 'ê²Œì‹œíŒ');

        let currentPostId = null;
        let fileData = null; 
        let isEditMode = false; // ìˆ˜ì • ëª¨ë“œì¸ì§€ í™•ì¸í•˜ëŠ” ë³€ìˆ˜

        // 1. ê²Œì‹œê¸€ ëª©ë¡ ë¡œë“œ
        async function loadList() {
            const listEl = document.getElementById('post-list');
            try {
                const q = query(collection(db, colName), orderBy("date", "desc"));
                const snap = await getDocs(q);
                
                listEl.innerHTML = '';
                if(snap.empty) {
                    listEl.innerHTML = '<div style="text-align:center; margin-top:80px; color:#aaa;">ì•„ì§ ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ê¸€ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!</div>';
                    return;
                }

                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const dateStr = new Date(d.date).toLocaleDateString();
                    const hasMedia = d.media ? 'ğŸ“·' : '';
                    
                    const item = document.createElement('div');
                    item.className = 'post-card';
                    item.onclick = () => openView(docSnap.id);
                    item.innerHTML = `
                        <div class="post-header-row">
                            <span class="badge-cat">${catTitles[category]}</span>
                            <span class="post-author">ìµëª…</span>
                        </div>
                        <h3 class="post-title">${d.title} <span style="font-size:12px; color:#2196F3;">${hasMedia}</span></h3>
                        <p class="post-preview">${d.content}</p>
                        <div class="post-footer">
                            <span>${dateStr}</span>
                            <div>
                                <span style="margin-right:8px;">ğŸ‘ ${d.likes || 0}</span>
                                <span>ğŸ’¬ ${d.comments ? d.comments.length : 0}</span>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(item);
                });
            } catch(e) {
                console.error(e);
                listEl.innerHTML = `<div style="text-align:center; padding:20px;">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨<br>ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>`;
            }
        }

        // 2. ê¸€ ì‘ì„± ë° ìˆ˜ì • ê´€ë ¨
        window.openWriteModal = () => {
            isEditMode = false;
            document.getElementById('write-header-title').innerText = "ìƒˆ ê¸€ ì‘ì„±";
            document.getElementById('btn-save').innerText = "ë“±ë¡";
            
            // ì´ˆê¸°í™”
            document.getElementById('w-title').value = '';
            document.getElementById('w-content').value = '';
            document.getElementById('w-pw').value = '';
            document.getElementById('w-file').value = '';
            document.getElementById('file-msg').innerText = "ğŸ“· ì‚¬ì§„ ë˜ëŠ” ë™ì˜ìƒ ì¶”ê°€ (í´ë¦­)";
            fileData = null;
            
            openModal('write-modal');
        };

        document.getElementById('w-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 500 * 1024) { 
                alert("íŒŒì¼ ìš©ëŸ‰ì€ 500KB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                this.value = ""; return;
            }
            const reader = new FileReader();
            reader.onload = (evt) => {
                fileData = evt.target.result;
                document.getElementById('file-msg').innerText = "âœ… íŒŒì¼ ì„ íƒë¨: " + file.name;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('btn-save').addEventListener('click', async () => {
            const title = document.getElementById('w-title').value;
            const content = document.getElementById('w-content').value;
            const pw = document.getElementById('w-pw').value;

            if(!title || !content || !pw) return alert("ì œëª©, ë‚´ìš©, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if(pw.length < 4) return alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.");

            const btn = document.getElementById('btn-save');
            btn.disabled = true;
            btn.innerText = "ì²˜ë¦¬ì¤‘...";

            try {
                const data = {
                    title, content, password: pw,
                    date: Date.now()
                };
                if(fileData) data.media = fileData; // íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ì¶”ê°€

                if (isEditMode) {
                    // ìˆ˜ì • ëª¨ë“œ
                    await updateDoc(doc(db, colName, currentPostId), data);
                    alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
                } else {
                    // ìƒˆ ê¸€ ëª¨ë“œ
                    data.likes = 0;
                    data.dislikes = 0;
                    data.comments = [];
                    await addDoc(collection(db, colName), data);
                    alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                }
                location.reload();
            } catch(e) {
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
                btn.disabled = false;
            }
        });

        // 3. ìƒì„¸ ë³´ê¸° ë° ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼
        window.openView = async (id) => {
            currentPostId = id;
            const snap = await getDoc(doc(db, colName, id));
            if(!snap.exists()) return alert("ì‚­ì œëœ ê¸€ì…ë‹ˆë‹¤.");

            const d = snap.data();
            document.getElementById('v-title').innerText = d.title;
            document.getElementById('v-meta').innerText = `ìµëª… Â· ${new Date(d.date).toLocaleString()}`;
            document.getElementById('v-content').innerText = d.content;
            document.getElementById('cnt-like').innerText = d.likes || 0;
            document.getElementById('cnt-dislike').innerText = d.dislikes || 0;

            const mBox = document.getElementById('v-media');
            mBox.innerHTML = '';
            if(d.media) {
                if(d.media.startsWith('data:video')) mBox.innerHTML = `<video src="${d.media}" controls></video>`;
                else mBox.innerHTML = `<img src="${d.media}">`;
            }

            renderComments(d.comments || []);
            openModal('view-modal');
        };

        // ì‚­ì œ ë²„íŠ¼
        document.getElementById('btn-delete').addEventListener('click', async () => {
            const pw = prompt("ê¸€ ì‘ì„± ì‹œ ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸(4ìë¦¬)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if(!pw) return;
            const snap = await getDoc(doc(db, colName, currentPostId));
            if(snap.data().password === pw) {
                if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    await deleteDoc(doc(db, colName, currentPostId));
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload();
                }
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        });

        // ìˆ˜ì • ë²„íŠ¼
        document.getElementById('btn-edit').addEventListener('click', async () => {
            const pw = prompt("ê¸€ ì‘ì„± ì‹œ ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸(4ìë¦¬)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if(!pw) return;
            
            const snap = await getDoc(doc(db, colName, currentPostId));
            const d = snap.data();
            
            if(d.password === pw) {
                // ë¹„ë°€ë²ˆí˜¸ ë§ìœ¼ë©´ ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜
                closeModal('view-modal');
                isEditMode = true;
                
                document.getElementById('write-header-title').innerText = "ê¸€ ìˆ˜ì •í•˜ê¸°";
                document.getElementById('btn-save').innerText = "ìˆ˜ì • ì™„ë£Œ";
                
                document.getElementById('w-title').value = d.title;
                document.getElementById('w-content').value = d.content;
                document.getElementById('w-pw').value = d.password;
                
                fileData = d.media; // ê¸°ì¡´ ë¯¸ë””ì–´ ìœ ì§€
                if(d.media) document.getElementById('file-msg').innerText = "âœ… ê¸°ì¡´ íŒŒì¼ ìœ ì§€ë¨ (ë³€ê²½í•˜ë ¤ë©´ í´ë¦­)";
                else document.getElementById('file-msg').innerText = "ğŸ“· ì‚¬ì§„ ë˜ëŠ” ë™ì˜ìƒ ì¶”ê°€ (í´ë¦­)";

                openModal('write-modal');
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        });

        // 4. ëŒ“ê¸€ ë° ì¢‹ì•„ìš” (ê¸°ì¡´ê³¼ ë™ì¼)
        window.addComment = async () => {
            const txt = document.getElementById('c-input').value;
            if(!txt) return;
            const newC = { content: txt, date: new Date().toISOString(), anonNum: Math.floor(Math.random()*999) };
            await updateDoc(doc(db, colName, currentPostId), { comments: arrayUnion(newC) });
            document.getElementById('c-input').value = '';
            const snap = await getDoc(doc(db, colName, currentPostId));
            renderComments(snap.data().comments);
        };

        function renderComments(arr) {
            const list = document.getElementById('comment-list');
            list.innerHTML = '';
            if(!arr.length) { list.innerHTML = '<div style="color:#bbb; font-size:13px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            arr.forEach(c => {
                const div = document.createElement('div');
                div.style.marginBottom = "10px";
                div.style.fontSize = "14px";
                div.innerHTML = `<span style="font-weight:bold; margin-right:5px;">ìµëª…${c.anonNum}</span> ${c.content}`;
                list.appendChild(div);
            });
        }

        window.handleVote = async (type) => {
            const key = `voted_${currentPostId}`;
            if(localStorage.getItem(key)) return alert("ì´ë¯¸ ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤.");
            const field = type === 'like' ? 'likes' : 'dislikes';
            await updateDoc(doc(db, colName, currentPostId), { [field]: increment(1) });
            localStorage.setItem(key, 'true');
            const el = document.getElementById(type === 'like' ? 'cnt-like' : 'cnt-dislike');
            el.innerText = parseInt(el.innerText) + 1;
        };

        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');

        loadList();
    </script>
</body>
</html>
