<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시판</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header sticky">
        <a href="index.html" class="back-btn">❮</a>
        <h2 id="board-title">게시판</h2>
        <button class="write-btn" onclick="document.getElementById('write-modal').classList.remove('hidden')">글쓰기</button>
    </header>

    <main id="post-list" class="post-list"></main>

    <div id="write-modal" class="modal hidden">
        <div class="modal-content">
            <h3>글쓰기</h3>
            <input type="text" id="input-title" placeholder="제목">
            <textarea id="input-content" placeholder="내용"></textarea>
            <input type="password" id="input-password" placeholder="비밀번호(삭제용)" maxlength="4">
            <div class="modal-buttons">
                <button onclick="document.getElementById('write-modal').classList.add('hidden')" class="cancel-btn">취소</button>
                <button id="submit-btn" class="confirm-btn">등록</button>
            </div>
        </div>
    </div>

    <script type="module">
        // -----------------------------------------------------------
        // ▼▼▼ 아까 복사한 Firebase 설정을 아래에 붙여넣으세요 ▼▼▼
        // -----------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 아래 const firebaseConfig 부분을 본인 것으로 바꿔야 합니다!
        const firebaseConfig = {
            apiKey: "AIzaSyBYhs32HhSXtCfTHjYDWs9-i_lCj7d8UTc",
            authDomain: "gunwi-board.firebaseapp.com",
            projectId: "gunwi-board",
            storageBucket: "gunwi-board.firebasestorage.app",
            messagingSenderId: "G-SVL5WXSXPK",
            appId: "1:343912898114:web:611e8204b8a38cdd1c57db"
        };
        // -----------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // URL에서 카테고리 가져오기
        const params = new URLSearchParams(window.location.search);
        const category = params.get('category') || 'free';
        const collectionName = 'gunwi_' + category;
        
        const categoryNames = { free: '자유', school: '학교', game: '게임', hobby: '취미' };
        document.getElementById('board-title').innerText = categoryNames[category] || '게시판';

        // 1. 게시글 불러오기 (Firebase에서)
        async function loadPosts() {
            const list = document.getElementById('post-list');
            list.innerHTML = '로딩중...';
            
            const q = query(collection(db, collectionName), orderBy("date", "desc"));
            const querySnapshot = await getDocs(q);
            
            list.innerHTML = '';
            querySnapshot.forEach((docSnap) => {
                const post = docSnap.data();
                const item = document.createElement('div');
                item.className = 'post-item';
                item.innerHTML = `
                    <div class="post-info">
                        <span class="post-item-title">${post.title}</span>
                        <span class="post-item-meta">익명 · ${new Date(post.date).toLocaleDateString()}</span>
                    </div>
                    <button class="delete-btn-small" data-id="${docSnap.id}" data-pw="${post.password}">삭제</button>
                `;
                list.appendChild(item);
            });

            // 삭제 버튼 이벤트 연결
            document.querySelectorAll('.delete-btn-small').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const pw = prompt("글 작성 시 비밀번호를 입력하세요:");
                    if (pw === e.target.dataset.pw) {
                        await deleteDoc(doc(db, collectionName, e.target.dataset.id));
                        alert("삭제됨!");
                        loadPosts();
                    } else {
                        alert("비번 틀림!");
                    }
                });
            });
        }

        // 2. 글 저장하기 (Firebase로)
        document.getElementById('submit-btn').addEventListener('click', async () => {
            const title = document.getElementById('input-title').value;
            const content = document.getElementById('input-content').value;
            const password = document.getElementById('input-password').value;

            if (!title || !content || !password) return alert("다 입력해주세요");

            try {
                await addDoc(collection(db, collectionName), {
                    title: title,
                    content: content,
                    password: password,
                    date: Date.now()
                });
                alert("등록 완료!");
                document.getElementById('write-modal').classList.add('hidden');
                document.getElementById('input-title').value = '';
                document.getElementById('input-content').value = '';
                document.getElementById('input-password').value = '';
                loadPosts(); // 목록 새로고침
            } catch (e) {
                console.error("Error: ", e);
                alert("등록 실패! (콘솔 확인)");
            }
        });

        // 시작하자마자 목록 불러오기
        loadPosts();
    </script>
</body>
</html>
