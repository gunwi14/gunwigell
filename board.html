<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="board-title">ê²Œì‹œíŒ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <a href="index.html" class="back-link">â†</a>
        <div class="board-info">
            <h1 id="header-category">ììœ  ê²Œì‹œíŒ</h1>
            <p>êµ°ìœ„ê³  ìµëª… ê²Œì‹œíŒ</p>
        </div>
        <span class="write-button" onclick="showWriteForm()">âœï¸</span>
        <span class="search-icon">ğŸ”</span>
    </header>

    <main class="post-container">
        <div id="posts-list">
            </div>

        <div id="write-form-overlay" class="overlay" style="display:none;">
            <div class="write-form-box">
                <h2>ìƒˆ ê¸€ ì‘ì„±</h2>
                <input type="text" id="post-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ìµëª…)" required>
                <textarea id="post-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                <div class="form-actions">
                    <button onclick="hideWriteForm()" class="cancel-btn">ì·¨ì†Œ</button>
                    <button onclick="submitPost()">ë“±ë¡í•˜ê¸°</button>
                </div>
            </div>
        </div>
        
        <div id="comment-overlay" class="overlay" style="display:none;">
            <div class="comment-box">
                <button class="close-btn" onclick="hideCommentOverlay()">X</button>
                <div id="current-post-view">
                    </div>
                <div id="comments-list">
                    </div>
                <div class="comment-input-area">
                    <input type="text" id="comment-input" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš” (ìµëª…)">
                    <button onclick="submitComment()">ë“±ë¡</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ê²Œì‹œê¸€ ë°ì´í„°ë¥¼ ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.
        const categoryMap = {
            'free': 'ììœ  ê²Œì‹œíŒ',
            'hobby': 'ì·¨ë¯¸/ìŠ¤í¬ì¸ ',
            'school': 'í•™êµ/í•™ì—…',
            'qna': 'ì§ˆë¬¸/ë‹µë³€'
        };

        let currentCategory = 'free';
        let currentPostId = null;

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const cat = params.get('category');
            if (cat && categoryMap[cat]) {
                currentCategory = cat;
                document.getElementById('header-category').textContent = categoryMap[cat];
                document.getElementById('board-title').textContent = categoryMap[cat] + ' - êµ°ìœ„ê³ ';
            }
            loadPosts();
        });

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê²Œì‹œê¸€ ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        function getPosts() {
            const key = `gunwi_posts_${currentCategory}`;
            return JSON.parse(localStorage.getItem(key)) || [];
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ê²Œì‹œê¸€ ëª©ë¡ì„ ì €ì¥í•©ë‹ˆë‹¤.
        function savePosts(posts) {
            const key = `gunwi_posts_${currentCategory}`;
            localStorage.setItem(key, JSON.stringify(posts));
        }

        // ê²Œì‹œê¸€ ëª©ë¡ì„ í™”ë©´ì— ë Œë”ë§í•©ë‹ˆë‹¤.
        function loadPosts() {
            const posts = getPosts();
            const listElement = document.getElementById('posts-list');
            listElement.innerHTML = '';
            
            if (posts.length === 0) {
                listElement.innerHTML = '<p class="no-posts">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ì‘ì„±í•´ ë³´ì„¸ìš”!</p>';
                return;
            }

            posts.sort((a, b) => b.id - a.id); // ìµœì‹  ê¸€ì´ ìœ„ë¡œ ì˜¤ë„ë¡ ì •ë ¬

            posts.forEach(post => {
                const postElement = document.createElement('article');
                postElement.classList.add('post-summary');
                postElement.setAttribute('data-post-id', post.id);
                
                const commentCount = post.comments ? post.comments.length : 0;
                
                postElement.innerHTML = `
                    <div class="post-header">
                        <span class="post-author">ìµëª…${post.anonId}</span>
                        <span class="post-meta-right">â‹®</span>
                    </div>
                    <h3 class="post-summary-title">${post.title}</h3>
                    <p class="post-summary-content">${post.content.substring(0, 50)}...</p>
                    <div class="post-meta">
                        <span class="timestamp">${post.date}</span>
                        <span class="views">ğŸ’¬ ${commentCount}</span>
                    </div>
                `;
                postElement.onclick = () => showCommentOverlay(post.id);
                listElement.appendChild(postElement);
            });
        }

        // ìƒˆ ê¸€ ì‘ì„± í¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.
        function showWriteForm() {
            document.getElementById('write-form-overlay').style.display = 'flex';
        }

        // ìƒˆ ê¸€ ì‘ì„± í¼ì„ ìˆ¨ê¹ë‹ˆë‹¤.
        function hideWriteForm() {
            document.getElementById('write-form-overlay').style.display = 'none';
            document.getElementById('post-title').value = '';
            document.getElementById('post-content').value = '';
        }

        // ê²Œì‹œê¸€ì„ ë“±ë¡í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.
        function submitPost() {
            const title = document.getElementById('post-title').value.trim();
            const content = document.getElementById('post-content').value.trim();

            if (!title || !content) {
                alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                return;
            }

            let posts = getPosts();
            const nextId = posts.length > 0 ? Math.max(...posts.map(p => p.id)) + 1 : 1;
            
            // ëª¨ë“  ê²Œì‹œíŒ í†µí‹€ì–´ ê°€ì¥ í° ìµëª… ë²ˆí˜¸ë¥¼ ì°¾ê¸° ìœ„í•œ ì„ì‹œ ë¡œì§
            const allPostsData = Object.keys(localStorage)
                .filter(key => key.startsWith('gunwi_posts_'))
                .flatMap(key => JSON.parse(localStorage.getItem(key)));
            
            const maxAnonId = allPostsData.reduce((max, post) => Math.max(max, post.anonId || 0), 0);
            
            const newPost = {
                id: nextId,
                anonId: maxAnonId + 1, // ìƒˆë¡œìš´ ìµëª… ë²ˆí˜¸ ë¶€ì—¬
                title: title,
                content: content,
                date: new Date().toLocaleDateString().slice(0, -1), // ì˜ˆ: 2025. 12. 16
                comments: []
            };

            posts.push(newPost);
            savePosts(posts);
            
            hideWriteForm();
            loadPosts(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        }

        // ëŒ“ê¸€ ì˜¤ë²„ë ˆì´ í‘œì‹œ (ê²Œì‹œê¸€ ìƒì„¸ ë³´ê¸°)
        function showCommentOverlay(postId) {
            currentPostId = postId;
            const posts = getPosts();
            const post = posts.find(p => p.id === postId);

            if (!post) return;

            // ê²Œì‹œê¸€ ìƒì„¸ ë‚´ìš© ë Œë”ë§
            document.getElementById('current-post-view').innerHTML = `
                <h3 class="detail-title">${post.title}</h3>
                <div class="detail-meta">
                    <span>ìµëª…${post.anonId}</span> | <span>${post.date}</span>
                </div>
                <p class="detail-content">${post.content.replace(/\n/g, '<br>')}</p>
                <hr>
            `;
            
            // ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§
            renderComments(post.comments);

            document.getElementById('comment-overlay').style.display = 'flex';
        }

        // ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜
        function renderComments(comments) {
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';

            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="no-comments">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.classList.add('comment-reply');
                commentElement.innerHTML = `
                    <div class="reply-header">
                        <span class="reply-user-id">ìµëª…${comment.anonId}</span>
                        <span class="reply-meta">${comment.time}</span>
                    </div>
                    <p class="reply-content">${comment.content}</p>
                `;
                commentsList.appendChild(commentElement);
            });
        }

        // ëŒ“ê¸€ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
        function hideCommentOverlay() {
            document.getElementById('comment-overlay').style.display = 'none';
            document.getElementById('comment-input').value = '';
            currentPostId = null;
        }

        // ëŒ“ê¸€ ë“±ë¡ ë° ì €ì¥
        function submitComment() {
            const commentInput = document.getElementById('comment-input');
            const commentContent = commentInput.value.trim();

            if (!commentContent) return;

            let posts = getPosts();
            const postIndex = posts.findIndex(p => p.id === currentPostId);
            
            if (postIndex === -1) return;

            // ëª¨ë“  ê²Œì‹œíŒì˜ ëª¨ë“  ëŒ“ê¸€ ìµëª… ID ì¤‘ ìµœëŒ€ê°’ì„ ì°¾ì•„ ë‹¤ìŒ ë²ˆí˜¸ ë¶€ì—¬
            const allData = Object.keys(localStorage)
                .filter(key => key.startsWith('gunwi_posts_'))
                .flatMap(key => JSON.parse(localStorage.getItem(key)));

            const allComments = allData.flatMap(post => post.comments || []);
            const allPosts = allData;

            const maxCommentAnonId = allComments.reduce((max, comment) => Math.max(max, comment.anonId || 0), 0);
            const maxPostAnonId = allPosts.reduce((max, post) => Math.max(max, post.anonId || 0), 0);
            
            const nextAnonId = Math.max(maxCommentAnonId, maxPostAnonId) + 1;

            const now = new Date();
            const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            const newComment = {
                anonId: nextAnonId,
                content: commentContent,
                time: time
            };

            posts[postIndex].comments.push(newComment);
            savePosts(posts);

            // í™”ë©´ ê°±ì‹ 
            renderComments(posts[postIndex].comments);
            commentInput.value = '';
            loadPosts(); // ë©”ì¸ ëª©ë¡ì˜ ëŒ“ê¸€ ìˆ˜ë„ ê°±ì‹ 
        }
    </script>
</body>
</html>
