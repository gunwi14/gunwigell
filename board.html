<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ê²Œì‹œíŒ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <a href="index.html" class="back-btn">â®</a>
        <h2 id="board-title">ê²Œì‹œíŒ</h2>
        <div style="width: 24px;"></div> </header>

    <main id="post-list" class="post-list">
        <div style="text-align:center; margin-top:50px; color:#999;">ë¡œë”©ì¤‘...</div>
    </main>

    <button class="fab-write" onclick="openModal('write-modal')">âœï¸</button>

    <div id="write-modal" class="modal">
        <div class="modal-content">
            <div class="top-bar">
                <button class="close-btn" onclick="closeModal('write-modal')">âœ•</button>
                <span style="font-weight:bold;">ìƒˆ ê¸€ ì‘ì„±</span>
                <button class="submit-btn" id="btn-save">ë“±ë¡</button>
            </div>
            
            <input type="text" id="w-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            <textarea id="w-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ìš•ì„¤ ê¸ˆì§€)"></textarea>
            
            <div style="display:flex; justify-content:space-between;">
                <label class="file-label">
                    ğŸ“· ì‚¬ì§„/ì˜ìƒ ì¶”ê°€
                    <input type="file" id="w-file" accept="image/*, video/*" style="display:none;">
                </label>
                <input type="password" id="w-pw" placeholder="ë¹„ë°€ë²ˆí˜¸(ì‚­ì œìš©)" style="width: 120px;" maxlength="4">
            </div>
            <div id="file-preview" style="font-size:12px; color:#2196F3;"></div>
        </div>
    </div>

    <div id="view-modal" class="modal">
        <div class="modal-content">
            <div class="top-bar">
                <button class="close-btn" onclick="closeModal('view-modal')">âœ•</button>
                <button class="submit-btn" style="background:#ff4444;" id="btn-delete">ì‚­ì œ</button>
            </div>

            <div class="view-body">
                <div class="view-title" id="v-title">ì œëª©</div>
                <div class="view-meta" id="v-meta">ì‘ì„±ì Â· ë‚ ì§œ</div>
                
                <div id="v-media" class="media-container"></div> <div class="view-text" id="v-content">ë‚´ìš©</div>

                <div class="vote-box">
                    <button class="vote-btn" onclick="handleVote('like')">
                        ğŸ‘ <span id="cnt-like">0</span>
                    </button>
                    <button class="vote-btn dislike" onclick="handleVote('dislike')">
                        ğŸ‘ <span id="cnt-dislike">0</span>
                    </button>
                </div>

                <div class="comments-area">
                    <div id="comment-list">
                        </div>
                    <div class="input-bar">
                        <input type="text" id="c-input" placeholder="ëŒ“ê¸€ ì…ë ¥...">
                        <button onclick="addComment()">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // â–¼â–¼â–¼ ì—¬ê¸°ì— ë³¸ì¸ì˜ Firebase ì„¤ì •ê°’ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” â–¼â–¼â–¼
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy, arrayUnion, increment } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ì´ ë¶€ë¶„ì€ ë³¸ì¸ì˜ Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•´ì˜¨ ê²ƒìœ¼ë¡œ ê¼­ ë°”ê¿”ì•¼ í•©ë‹ˆë‹¤!
        const firebaseConfig = {
            apiKey: "AIzaSyBYhs32HhSXtCfTHjYDWs9-i_lCj7d8UTc",
            authDomain: "gunwi-board.firebaseapp.com",
            projectId: "gunwi-board",
            storageBucket: "gunwi-board.firebasestorage.app",
            messagingSenderId: "343912898114",
            appId: "1:343912898114:web:611e8204b8a38cdd1c57db"
        };
        // â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ìˆ˜ì •í•˜ì„¸ìš” â–²â–²â–²

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ì¹´í…Œê³ ë¦¬ ì„¤ì •
        const params = new URLSearchParams(window.location.search);
        const category = params.get('category') || 'free';
        const colName = `gunwi_${category}`;
        const catTitles = { free:'ììœ ', school:'í•™êµ', game:'ê²Œì„', love:'ì—°ì• ', food:'ê¸‰ì‹', qna:'ì§ˆë¬¸' };
        document.getElementById('board-title').innerText = catTitles[category] || 'ê²Œì‹œíŒ';

        let currentPostId = null;
        let fileData = null; // ì—…ë¡œë“œí•  íŒŒì¼(Base64)

        // 1. ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadList() {
            const listEl = document.getElementById('post-list');
            try {
                const q = query(collection(db, colName), orderBy("date", "desc"));
                const snap = await getDocs(q);
                
                listEl.innerHTML = '';
                if(snap.empty) {
                    listEl.innerHTML = '<div style="text-align:center; margin-top:50px; color:#aaa;">ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. 1ë“±ìœ¼ë¡œ ì‘ì„±í•´ë³´ì„¸ìš”!</div>';
                    return;
                }

                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const dateStr = new Date(d.date).toLocaleDateString();
                    const hasMedia = d.media ? 'ğŸ“·' : '';
                    
                    const item = document.createElement('div');
                    item.className = 'post-card';
                    item.onclick = () => openView(docSnap.id);
                    item.innerHTML = `
                        <div class="post-header-row">
                            <span class="badge-cat">${catTitles[category]}</span>
                            <span class="post-author">ìµëª…</span>
                        </div>
                        <h3 class="post-title">${d.title} <span style="font-size:12px;">${hasMedia}</span></h3>
                        <p class="post-preview">${d.content}</p>
                        <div class="post-footer">
                            <span>${dateStr}</span>
                            <div class="post-stats">
                                <span>ğŸ‘ ${d.likes || 0}</span>
                                <span>ğŸ’¬ ${d.comments ? d.comments.length : 0}</span>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(item);
                });
            } catch(e) {
                console.error(e);
                listEl.innerHTML = `<div style="text-align:center; padding:20px;">ì˜¤ë¥˜ ë°œìƒ!<br>Firebase ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.</div>`;
            }
        }

        // 2. ê¸€ì“°ê¸° ê¸°ëŠ¥ (íŒŒì¼ ìš©ëŸ‰ ì²´í¬ í¬í•¨)
        document.getElementById('w-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 500KB ì œí•œ (ë¬´ë£Œ DB ìš©ëŸ‰ ì´ˆê³¼ ë°©ì§€)
            if (file.size > 500 * 1024) { 
                alert("íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤! (500KB ì´í•˜ë§Œ ê°€ëŠ¥)\nìš©ëŸ‰ì„ ì¤„ì—¬ì„œ ì˜¬ë ¤ì£¼ì„¸ìš”.");
                this.value = ""; 
                return;
            }

            const reader = new FileReader();
            reader.onload = (evt) => {
                fileData = evt.target.result;
                document.getElementById('file-preview').innerText = "íŒŒì¼ ì„ íƒë¨: " + file.name;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('btn-save').addEventListener('click', async () => {
            const title = document.getElementById('w-title').value;
            const content = document.getElementById('w-content').value;
            const pw = document.getElementById('w-pw').value;

            if(!title || !content || !pw) return alert("ì œëª©, ë‚´ìš©, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.getElementById('btn-save');
            btn.innerText = "ë“±ë¡ì¤‘...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, colName), {
                    title, content, password: pw,
                    media: fileData, // ì´ë¯¸ì§€/ë¹„ë””ì˜¤ ë°ì´í„°
                    date: Date.now(),
                    likes: 0, dislikes: 0,
                    comments: []
                });
                alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                location.reload();
            } catch(e) {
                alert("ë“±ë¡ ì‹¤íŒ¨: " + e.message);
                btn.innerText = "ë“±ë¡";
                btn.disabled = false;
            }
        });

        // 3. ìƒì„¸ ë³´ê¸° ê¸°ëŠ¥
        window.openView = async (id) => {
            currentPostId = id;
            const docSnap = await getDoc(doc(db, colName, id));
            if(!docSnap.exists()) return alert("ì‚­ì œëœ ê¸€ì…ë‹ˆë‹¤.");

            const d = docSnap.data();
            document.getElementById('v-title').innerText = d.title;
            document.getElementById('v-meta').innerText = `ìµëª… Â· ${new Date(d.date).toLocaleString()}`;
            document.getElementById('v-content').innerText = d.content;
            document.getElementById('cnt-like').innerText = d.likes || 0;
            document.getElementById('cnt-dislike').innerText = d.dislikes || 0;

            // ë¯¸ë””ì–´ ì²˜ë¦¬
            const mediaBox = document.getElementById('v-media');
            mediaBox.innerHTML = '';
            if(d.media) {
                if(d.media.startsWith('data:video')) {
                    mediaBox.innerHTML = `<video src="${d.media}" controls></video>`;
                } else {
                    mediaBox.innerHTML = `<img src="${d.media}">`;
                }
            }

            // ëŒ“ê¸€ ë Œë”ë§
            renderComments(d.comments || []);
            
            openModal('view-modal');
        };

        // 4. ëŒ“ê¸€ ë“±ë¡
        window.addComment = async () => {
            const txt = document.getElementById('c-input').value;
            if(!txt) return;
            
            const newComment = {
                content: txt,
                date: new Date().toISOString(),
                anonNum: Math.floor(Math.random() * 999) // ëœë¤ ìµëª… ë²ˆí˜¸
            };

            await updateDoc(doc(db, colName, currentPostId), {
                comments: arrayUnion(newComment)
            });

            document.getElementById('c-input').value = '';
            // í™”ë©´ ê°±ì‹ ì„ ìœ„í•´ ë‹¤ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            const snap = await getDoc(doc(db, colName, currentPostId));
            renderComments(snap.data().comments);
        };

        function renderComments(arr) {
            const list = document.getElementById('comment-list');
            list.innerHTML = '';
            if(!arr || arr.length === 0) {
                list.innerHTML = '<div style="color:#bbb; padding:10px;">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>';
                return;
            }
            arr.forEach(c => {
                const div = document.createElement('div');
                div.className = 'comment-item';
                div.innerHTML = `<span class="comment-author">ìµëª…${c.anonNum}</span> ${c.content}`;
                list.appendChild(div);
            });
        }

        // 5. ì¢‹ì•„ìš”/ì‹«ì–´ìš”
        window.handleVote = async (type) => {
            if(!currentPostId) return;
            
            // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ë¡œ ì¤‘ë³µ íˆ¬í‘œ ë°©ì§€ (ê°„ë‹¨í•œ ë²„ì „)
            const votedKey = `voted_${currentPostId}`;
            if(localStorage.getItem(votedKey)) return alert("ì´ë¯¸ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤.");

            const field = type === 'like' ? 'likes' : 'dislikes';
            await updateDoc(doc(db, colName, currentPostId), {
                [field]: increment(1)
            });
            
            localStorage.setItem(votedKey, 'true');
            
            // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            const el = document.getElementById(type === 'like' ? 'cnt-like' : 'cnt-dislike');
            el.innerText = parseInt(el.innerText) + 1;
        };

        // 6. ì‚­ì œ ê¸°ëŠ¥
        document.getElementById('btn-delete').addEventListener('click', async () => {
            const pw = prompt("ì‘ì„± ì‹œ ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if(!pw) return;

            const snap = await getDoc(doc(db, colName, currentPostId));
            if(snap.data().password === pw) {
                if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    await deleteDoc(doc(db, colName, currentPostId));
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload();
                }
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!");
            }
        });

        // ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜ (ì „ì—­)
        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');

        // ì´ˆê¸° ì‹¤í–‰
        loadList();

    </script>
</body>
</html>
